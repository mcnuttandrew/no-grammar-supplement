{
  "title": "Filtering the lowest half while Sorting",
  "gemSpecs": [
    {
      "meta": {"name": "Sort -> Filter"},
      "timeline": {
        "concat": [
          {
            "sync": [
              {
                "component": {"mark": "marks"},
                "change": {"data": false, "scale": {"y": {"data": false}}},
                "timing": {"duration": {"ratio": 0.5}}
              },
              {
                "component": {"axis": "y"},
                "change": {"scale": {"data": false}, "signal": false},
                "timing": {"duration": {"ratio": 0.5}}
              }
            ]
          },
          {
            "sync": [
              {
                "component": {"mark": "marks"},
                "change": {"data": ["student"]},
                "timing": {"duration": {"ratio": 0.5}}
              },
              {
                "component": {"axis": "y"},
                "timing": {"duration": {"ratio": 0.5}}
              },
              {
                "component": {"axis": "x"},
                "timing": {"duration": {"ratio": 0.5}}
              },
              {"component": "view", "timing": {"duration": {"ratio": 0.5}}}
            ]
          }
        ]
      },
      "totalDuration": 2000
    },
    {
      "meta": {"name": "At once"},
      "timeline": {
        "sync": [
          {
            "component": {"mark": "marks"},
            "timing": {"duration": {"ratio": 1}}
          },
          {"component": {"axis": "y"}, "timing": {"duration": {"ratio": 1}}},
          {"component": {"axis": "x"}, "timing": {"duration": {"ratio": 1}}},
          {"component": "view", "timing": {"duration": {"ratio": 1}}}
        ]
      },
      "totalDuration": 2000
    }
  ],
  "sSpec": {
    "$schema": "https://vega.github.io/schema/vega/v5.json",
    "description": "A bar graph showing the scores of the top 5 students. This shows an example of the window transform, for how the top K (5) can be filtered, and also how a rank can be computed for each student.",
    "autosize": "pad",
    "padding": 5,
    "width": 200,
    "style": "cell",
    "data": [
      {"name": "source_0", "values": []},
      {
        "name": "data_0",
        "source": "source_0",
        "transform": [
          {
            "type": "window",
            "params": [null],
            "as": ["rank"],
            "ops": ["rank"],
            "fields": [null],
            "sort": {"field": ["score"], "order": ["descending"]}
          },
          {"type": "filter", "expr": "datum.rank <= 10"}
        ]
      },
      {
        "name": "data_1",
        "source": "data_0",
        "transform": [
          {
            "type": "filter",
            "expr": "datum[\"score\"] !== null && !isNaN(datum[\"score\"])"
          }
        ]
      }
    ],
    "signals": [
      {"name": "y_step", "value": 20},
      {
        "name": "height",
        "update": "bandspace(domain('y').length, 0.1, 0.05) * y_step"
      }
    ],
    "marks": [
      {
        "name": "marks",
        "type": "rect",
        "style": ["bar"],
        "from": {"data": "data_1"},
        "encode": {
          "update": {
            "fill": {"value": "#4c78a8"},
            "x2": {"scale": "x", "field": "score"},
            "x": {"scale": "x", "value": 0},
            "y": {"scale": "y", "field": "student"},
            "height": {"scale": "y", "band": true}
          }
        }
      }
    ],
    "scales": [
      {
        "name": "x",
        "type": "linear",
        "domain": {"data": "data_1", "field": "score"},
        "range": [0, {"signal": "width"}],
        "nice": true,
        "zero": true
      },
      {
        "name": "y",
        "type": "band",
        "domain": {"data": "data_0", "field": "student"},
        "range": {"step": {"signal": "y_step"}},
        "paddingInner": 0.1,
        "paddingOuter": 0.05
      }
    ],
    "axes": [
      {
        "scale": "x",
        "orient": "bottom",
        "gridScale": "y",
        "grid": true,
        "title": "Score",
        "labelFlush": true,
        "labelOverlap": true,
        "tickCount": {"signal": "ceil(width/40)"},
        "zindex": 0,
        "encode": {"axis": {"name": "x"}}
      },
      {
        "scale": "y",
        "orient": "left",
        "grid": false,
        "title": "Student",
        "zindex": 0,
        "encode": {"axis": {"name": "y"}}
      }
    ]
  },
  "eSpec": {
    "$schema": "https://vega.github.io/schema/vega/v5.json",
    "description": "A bar graph showing the scores of the top 5 students. This shows an example of the window transform, for how the top K (5) can be filtered, and also how a rank can be computed for each student.",
    "autosize": "pad",
    "padding": 5,
    "width": 200,
    "style": "cell",
    "data": [
      {"name": "source_0", "values": []},
      {
        "name": "data_0",
        "source": "source_0",
        "transform": [
          {
            "type": "window",
            "params": [null],
            "as": ["rank"],
            "ops": ["rank"],
            "fields": [null],
            "sort": {"field": ["score"], "order": ["descending"]}
          },
          {"type": "filter", "expr": "datum.rank <= 5"}
        ]
      },
      {
        "name": "data_1",
        "source": "data_0",
        "transform": [
          {
            "type": "filter",
            "expr": "datum[\"score\"] !== null && !isNaN(datum[\"score\"])"
          }
        ]
      }
    ],
    "signals": [
      {"name": "y_step", "value": 20},
      {
        "name": "height",
        "update": "bandspace(domain('y').length, 0.1, 0.05) * y_step"
      }
    ],
    "marks": [
      {
        "name": "marks",
        "type": "rect",
        "style": ["bar"],
        "from": {"data": "data_1"},
        "encode": {
          "update": {
            "fill": {"value": "#4c78a8"},
            "x2": {"scale": "x", "field": "score"},
            "x": {"scale": "x", "value": 0},
            "y": {"scale": "y", "field": "student"},
            "height": {"scale": "y", "band": true}
          }
        }
      }
    ],
    "scales": [
      {
        "name": "x",
        "type": "linear",
        "domain": {"data": "data_1", "field": "score"},
        "range": [0, {"signal": "width"}],
        "nice": true,
        "zero": true
      },
      {
        "name": "y",
        "type": "band",
        "domain": {
          "data": "data_0",
          "field": "student",
          "sort": {"op": "average", "field": "score", "order": "descending"}
        },
        "range": {"step": {"signal": "y_step"}},
        "paddingInner": 0.1,
        "paddingOuter": 0.05
      }
    ],
    "axes": [
      {
        "scale": "x",
        "orient": "bottom",
        "gridScale": "y",
        "grid": true,
        "title": "Score",
        "labelFlush": true,
        "labelOverlap": true,
        "tickCount": {"signal": "ceil(width/40)"},
        "zindex": 0,
        "encode": {"axis": {"name": "x"}}
      },
      {
        "scale": "y",
        "orient": "left",
        "grid": false,
        "title": "Student",
        "zindex": 0,
        "encode": {"axis": {"name": "y"}}
      }
    ]
  },
  "data": [
    {"student": "A", "score": 100},
    {"student": "B", "score": 56},
    {"student": "C", "score": 88},
    {"student": "D", "score": 65},
    {"student": "E", "score": 45},
    {"student": "F", "score": 23},
    {"student": "G", "score": 66},
    {"student": "H", "score": 67},
    {"student": "I", "score": 13},
    {"student": "J", "score": 12},
    {"student": "K", "score": 50},
    {"student": "L", "score": 78},
    {"student": "M", "score": 66},
    {"student": "N", "score": 30},
    {"student": "O", "score": 97},
    {"student": "P", "score": 75},
    {"student": "Q", "score": 24},
    {"student": "R", "score": 42},
    {"student": "S", "score": 76},
    {"student": "T", "score": 78},
    {"student": "U", "score": 21},
    {"student": "V", "score": 46}
  ],
  "userInput": {
    "marks": {"marks": {"change": {"data": ["student"]}}},
    "scales": {"x": {"domainDimension": "same"}, "y": {"domainDimension": "same"}}
  }
}